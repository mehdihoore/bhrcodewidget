<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تاریخچه گفتگو</title>
    <!-- Add similar CSS/Fonts as your widget if desired -->
    <style>
        body { font-family: 'Vazirmatn', sans-serif; padding: 20px; background-color: #f4f4f4; }
        #history-container { background: #fff; padding: 15px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .message { margin-bottom: 10px; padding: 8px 12px; border-radius: 5px; max-width: 80%; }
        .user { background-color: #e1f5fe; margin-left: auto; text-align: right; }
        .bot { background-color: #f0f0f0; margin-right: auto; text-align: right; }
        .timestamp { font-size: 0.75em; color: #888; margin-top: 3px; }
        #loading-history { text-align: center; padding: 20px; }
        #error-history { color: red; text-align: center; padding: 20px; }
    </style>
</head>
<body>
    <h1>تاریخچه گفتگو</h1>
    <div id="loading-history">در حال بارگذاری تاریخچه...</div>
    <div id="error-history" style="display: none;"></div>
    <div id="history-container" style="display: none;">
        <!-- History will be loaded here -->
    </div>

    <script>
        const historyContainer = document.getElementById('history-container');
        const loadingDiv = document.getElementById('loading-history');
        const errorDiv = document.getElementById('error-history');

        async function loadHistory() {
            const urlParams = new URLSearchParams(window.location.search);
            const sessionId = urlParams.get('session');

            if (!sessionId) {
                showErrorHistory("شناسه گفتگو یافت نشد.");
                return;
            }

            // Use the correct API endpoint from your worker
            const historyApiUrl = `/api/get-history/${sessionId}`; 

            try {
                const response = await fetch(historyApiUrl);
                if (!response.ok) {
                    let errorMsg = `خطا در دریافت تاریخچه: ${response.status}`;
                    try { errorMsg = (await response.json()).error || errorMsg; } catch {}
                    throw new Error(errorMsg);
                }

                const history = await response.json();
                displayHistory(history);

            } catch (error) {
                console.error("Error loading history:", error);
                showErrorHistory(error.message || "خطای ناشناخته در بارگذاری تاریخچه.");
            } finally {
                loadingDiv.style.display = 'none';
            }
        }

        function displayHistory(history) {
            if (!history || history.length === 0) {
                historyContainer.innerHTML = "<p>تاریخچه‌ای برای این گفتگو یافت نشد.</p>";
                historyContainer.style.display = 'block';
                return;
            }

            historyContainer.innerHTML = ''; // Clear previous
            history.forEach(msg => {
                const msgDiv = document.createElement('div');
                msgDiv.classList.add('message', msg.role); // 'user' or 'bot'
                // Basic text display - could use markdown renderer here too if needed
                msgDiv.textContent = msg.content;

                const timeDiv = document.createElement('div');
                timeDiv.classList.add('timestamp');
                timeDiv.textContent = new Date(msg.timestamp).toLocaleString('fa-IR'); // Format timestamp
                msgDiv.appendChild(timeDiv);

                historyContainer.appendChild(msgDiv);
            });
            historyContainer.style.display = 'block';
        }

        function showErrorHistory(message) {
             errorDiv.textContent = message;
             errorDiv.style.display = 'block';
             loadingDiv.style.display = 'none';
             historyContainer.style.display = 'none';
        }

        // Load history when the page loads
        document.addEventListener('DOMContentLoaded', loadHistory);
    </script>
</body>
</html>